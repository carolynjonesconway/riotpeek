<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<style type="text/css">

	body {
		text-align: center;
		background-color: #D3D3D1;
	}

	#top-row {
		background-image: url('static/img/caitlyn-short.jpg');
		background-size: 100%;
		background-repeat: no-repeat;
		margin-bottom: 2em;
	}

	h1, #game-status {
		text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
		color: white;
	}

	table, th, td {
		text-align: center;
		margin: 0 auto;
	}

	table {
		width: 60%;
		background-color: rgba(255,255,255,0.5);
	}

	</style>

	<title>RiotPeek</title>
</head>
<body>
	<div class="container-fluid">
		<div id="top-row" class="row">
			<div class="col-xs-12">
				<h1>RiotPeek</h1>
				<form>
					<label class="form-group">
						<input id="summoner-name" class="form-control" type="text" value="grizzlies" placeholder="summoner">
					</label>
					<label class="form-group">
						<input id="summoner-submit" class="btn btn-default" type="submit">
					</label>
				</form>
				<p id="game-status" style="height: 25px"></p>
				<img src="/static/img/loading.gif" class="invisible" style="width: 60px">

			</div>
		</div>
		<div class="row" style="height: 250px">
			<div class="col-xs-6">
				<table class="invisible table table-hover">
					<thead>
						<th>Summoner</th>
						<th>Champion</th>
					</thead>
					<tbody id="teamOne"></tbody>
				</table>
			</div>
			<div class="col-xs-6">
				<table class="invisible table table-hover">
					<thead>
						<th>Summoner</th>
						<th>Champion</th>
					</thead>
					<tbody id="teamTwo"></tbody>
				</table>
			</div>
		</div>
		<p>RiotPeek is not endorsed by Riot Games and does not reflect the views or opinions of Riot Games or anyone officially involved in producing or managing League of Legends. League of Legends and Riot Games are trademarks or registered trademarks of Riot Games, Inc. League of Legends Â© Riot Games, Inc.
		</p>
	</div>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
<script>

$('#summoner-submit').click(findGame);

function findGame(evt) {
	evt.preventDefault();

	// Get summoner name from the DOM
	var summoner = $('#summoner-name').val();
	var formInput = {
		summoner: summoner
	};
	
	// Update the DOM for loading
	$('img').removeClass('invisible');
	$('table').addClass('invisible');
	$('#game-status').text('');
	$('#teamOne').text('');
	$('#teamTwo').text('');

	// Get the game from the Riot API
	$.get('/find_game', formInput, function(response) {
		var game = JSON.parse(response).game;
		var summonerId = JSON.parse(response).summonerId;

		if (summonerId) {
			if (game) {

				console.log(game);

				// Determine game duration
				var gameStartEpochMillesecs = game.gameStartTime;
				var gameStartEpochSecs = gameStartEpochMillesecs/1000;
				var gameStart = moment.unix(gameStartEpochSecs);
				var gameDuration = moment(gameStart).fromNow(true);

				// Determine game type
				var ranked = [4, 6, 9, 41, 42];
				if (game.gameQueueConfigId in ranked) {
					var gameType = 'ranked'
				} else {
					var gameType = 'normal'
				};
				
				var gameStatus = summoner + ' has been in a ' + gameType + ' game for ' + gameDuration + '.'
				var teamOneId = game.participants[0].teamId

				// Add player info to the DOM
				$.get('/get_champs', function(response) {
					
					var champions = JSON.parse(response);

					// Calculate player info
					for (var i=0; i < game.participants.length; i++) {
						var participant = game.participants[i]
						var participantInfo = $('<li>').text(participant.summonerName)

						// Determine the correct champion
						participantInfo = '<tr>\
												<td>' + participant.summonerName + '</td>\
												<td>' + champions[participant.championId] + '</td>\
											</tr>';

						// Determine the correct team
						if (participant.teamId === teamOneId) {
							$('#teamOne').append(participantInfo);
						} else {
							$('#teamTwo').append(participantInfo);
						};	
					};
				});
				$('table').removeClass('invisible');
			} else {
				var gameStatus = summoner + ' is not currently in game.'
			};
		} else {
			var gameStatus = 'No summoner by the name ' + summoner + ' could be found.'
		};
		$('img').addClass('invisible');
		$('#game-status').text(gameStatus);
	})
}


</script>
</body>
</html>